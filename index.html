<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Door-to-Door Canvassing App</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Mobile-first responsive design */
        #map { 
            height: 300px;
            width: 100%;
        }
        
        @media (min-width: 768px) {
            #map { height: 400px; }
        }
        
        @media (min-width: 992px) {
            #map { height: 500px; }
        }
        
        .voter-card { 
            border-left: 4px solid #007bff; 
            margin-bottom: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .voter-card.visited { border-left-color: #28a745; background-color: #f8f9fa; }
        .voter-card.current { border-left-color: #ffc107; background-color: #fff3cd; }
        .voter-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        .proximity-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .proximity-good { background-color: #28a745; }
        .proximity-medium { background-color: #ffc107; }
        .proximity-far { background-color: #dc3545; }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        .canvasser-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 0.85rem;
            max-width: 200px;
        }
        
        @media (max-width: 767px) {
            .canvasser-status {
                top: 5px;
                right: 5px;
                left: 5px;
                max-width: none;
                font-size: 0.8rem;
                padding: 6px 8px;
            }
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 15px;
        }
        
        .demo-controls {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        /* Mobile optimizations */
        @media (max-width: 767px) {
            .container-fluid { padding: 0.5rem; }
            
            .card-body { padding: 0.75rem; }
            
            .voter-card .card-body { padding: 0.5rem; }
            
            .btn-sm { 
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
            
            .form-select-sm, .form-control { 
                padding: 0.375rem 0.75rem;
                font-size: 0.9rem;
            }
            
            .summary-card { padding: 10px; }
            
            /* Stack columns on mobile */
            .mobile-stack { 
                margin-bottom: 1rem;
            }
            
            /* Better touch targets */
            .btn { min-height: 44px; }
            .form-check-input { transform: scale(1.2); }
            
            /* Optimize voter list for mobile */
            #voterList {
                max-height: 400px;
            }
        }
        
        /* Party color indicators */
        .party-republican { border-left-color: #dc3545 !important; }
        .party-democrat { border-left-color: #007bff !important; }
        .party-independent { border-left-color: #6c757d !important; }
        
        /* Legend */
        .map-legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid #fff;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <nav class="navbar navbar-dark bg-primary mb-3">
            <div class="container-fluid">
                <span class="navbar-brand mb-0 h1">
                    <i class="fas fa-door-open"></i> Canvassing Command Center
                </span>
                <span class="navbar-text">
                    <i class="fas fa-users"></i> <span id="totalVoters">0</span> Voters | 
                    <i class="fas fa-check"></i> <span id="visitedCount">0</span> Visited
                </span>
            </div>
        </nav>

        <!-- Demo Controls -->
        <div class="demo-controls">
            <h5><i class="fas fa-gamepad"></i> Demo Controls</h5>
            <button class="btn btn-sm btn-success me-2" onclick="simulateGPSTracking()">
                <i class="fas fa-location-arrow"></i> Start GPS Simulation
            </button>
            <button class="btn btn-sm btn-warning me-2" onclick="generateDemoData()">
                <i class="fas fa-refresh"></i> Regenerate Demo Data
            </button>
            <button class="btn btn-sm btn-info" onclick="autoVisitNearby()">
                <i class="fas fa-magic"></i> Auto-Visit Nearby (Demo)
            </button>
        </div>

        <!-- Canvasser Status -->
        <div class="canvasser-status">
            <div><i class="fas fa-user"></i> Canvasser: Demo User</div>
            <div><i class="fas fa-location-dot"></i> Status: <span id="locationStatus">Searching...</span></div>
            <div><i class="fas fa-clock"></i> Time in Area: <span id="timeInArea">0</span>s</div>
        </div>

        <div class="row">
            <!-- Mobile-first layout -->
            
            <!-- Map Panel - Show first on mobile -->
            <div class="col-12 col-lg-4 order-2 order-lg-2 mobile-stack">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-map"></i> Map</h6>
                        <small class="text-muted">Party Colors</small>
                    </div>
                    <div class="card-body p-0 position-relative">
                        <div id="map"></div>
                        <!-- Map Legend -->
                        <div class="map-legend position-absolute" style="bottom: 10px; left: 10px; z-index: 1000;">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #dc3545;"></div>
                                <span>Republican</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #007bff;"></div>
                                <span>Democrat</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #6c757d;"></div>
                                <span>Independent</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters and Voter List -->
            <div class="col-12 col-lg-4 order-1 order-lg-1 mobile-stack">
                <!-- Filters -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-filter"></i> Filters</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label small">Zip Code</label>
                                <select class="form-select form-select-sm" id="zipFilter" onchange="applyFilters()">
                                    <option value="">All Zips</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label small">Party</label>
                                <select class="form-select form-select-sm" id="partyFilter" onchange="applyFilters()">
                                    <option value="">All Parties</option>
                                    <option value="Democrat">Democrat</option>
                                    <option value="Republican">Republican</option>
                                    <option value="Independent">Independent</option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-2 mt-1">
                            <div class="col-6">
                                <label class="form-label small">Street</label>
                                <select class="form-select form-select-sm" id="streetFilter" onchange="applyFilters()">
                                    <option value="">All Streets</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label small">Precinct</label>
                                <select class="form-select form-select-sm" id="precinctFilter" onchange="applyFilters()">
                                    <option value="">All Precincts</option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-2 mt-1">
                            <div class="col-12">
                                <label class="form-label small">Status</label>
                                <select class="form-select form-select-sm" id="statusFilter" onchange="applyFilters()">
                                    <option value="">All Status</option>
                                    <option value="visited">Visited</option>
                                    <option value="not-visited">Not Visited</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters()">
                                <i class="fas fa-times"></i> Clear Filters
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Voter List -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-list"></i> Voter List <span class="badge bg-secondary" id="listCount">0</span></h6>
                    </div>
                    <div class="card-body" id="voterList">
                        <!-- Voter cards will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Current Voter & Notes -->
            <div class="col-12 col-lg-4 order-3 order-lg-3 mobile-stack">
                <!-- Current Voter -->
                <div class="card mb-3" id="currentVoterCard" style="display: none;">
                    <div class="card-header bg-warning">
                        <h5><i class="fas fa-crosshairs"></i> Current Voter</h5>
                    </div>
                    <div class="card-body" id="currentVoterInfo">
                        <!-- Current voter info -->
                    </div>
                </div>

                <!-- Notes Form -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5><i class="fas fa-pen"></i> Canvassing Notes</h5>
                    </div>
                    <div class="card-body">
                        <form id="notesForm">
                            <div class="mb-3">
                                <label class="form-label">Voter Response</label>
                                <div class="row">
                                    <div class="col-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="present">
                                            <label class="form-check-label" for="present">Present</label>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="willVote">
                                            <label class="form-check-label" for="willVote">Will Vote</label>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="nextTime">
                                            <label class="form-check-label" for="nextTime">Next Time</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" id="voterNotes" rows="3" placeholder="Enter conversation notes..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Support Level</label>
                                <select class="form-select" id="supportLevel">
                                    <option value="">Select...</option>
                                    <option value="strong-support">Strong Support</option>
                                    <option value="lean-support">Lean Support</option>
                                    <option value="undecided">Undecided</option>
                                    <option value="lean-oppose">Lean Oppose</option>
                                    <option value="strong-oppose">Strong Oppose</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-save"></i> Save & Mark Visited
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Daily Summary -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> Today's Summary</h5>
                        <button class="btn btn-sm btn-outline-primary float-end" onclick="generateSummary()">
                            <i class="fas fa-refresh"></i> Update
                        </button>
                    </div>
                    <div class="card-body" id="summaryContent">
                        <p class="text-muted">Click "Update" to generate summary</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <script>
        // Global variables
        let map;
        let votersData = [];
        let filteredVoters = [];
        let currentVoter = null;
        let canvasserLocation = null;
        let locationWatchId = null;
        let proximityTimer = null;
        let timeInCurrentArea = 0;
        let markers = {};

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            generateDemoData();
            populateFilters();
            applyFilters(); // This will display voters and update map
            updateCounts();
        });

        // Initialize Leaflet map
        function initializeMap() {
            map = L.map('map').setView([33.1507, -96.8236], 13); // Frisco, TX
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        }

        // Generate demo voter data
        function generateDemoData() {
            votersData = [];
            filteredVoters = [];
            markers = {};
            
            const streets = ['Main St', 'Oak Ave', 'Elm St', 'Park Dr', 'Cedar Ln', 'Pine St', 'Maple Ave', 'First St', 'Second St', 'Third St'];
            const parties = ['Democrat', 'Republican', 'Independent'];
            const ageClasses = ['18-25', '26-35', '36-45', '46-55', '56-65', '65+'];
            const races = ['White', 'Hispanic', 'Black', 'Asian', 'Other'];
            const genders = ['Male', 'Female'];
            const zipCodes = ['75034', '75035', '75036'];
            const precincts = ['P001', 'P002', 'P003', 'P004', 'P005'];

            // Generate 500 voters
            for (let i = 0; i < 500; i++) {
                const lat = 33.1507 + (Math.random() - 0.5) * 0.02;
                const lng = -96.8236 + (Math.random() - 0.5) * 0.02;
                const street = streets[Math.floor(Math.random() * streets.length)];
                const houseNumber = Math.floor(Math.random() * 9999) + 1;
                
                const voter = {
                    id: i + 1,
                    name: generateRandomName(),
                    address: `${houseNumber} ${street}`,
                    city: 'Frisco',
                    state: 'TX',
                    zip: zipCodes[Math.floor(Math.random() * zipCodes.length)],
                    lat: lat,
                    lng: lng,
                    party: parties[Math.floor(Math.random() * parties.length)],
                    ageClass: ageClasses[Math.floor(Math.random() * ageClasses.length)],
                    race: races[Math.floor(Math.random() * races.length)],
                    gender: genders[Math.floor(Math.random() * genders.length)],
                    precinct: precincts[Math.floor(Math.random() * precincts.length)],
                    visited: false,
                    notes: '',
                    present: false,
                    willVote: false,
                    nextTime: false,
                    supportLevel: '',
                    visitedAt: null
                };
                
                votersData.push(voter);
            }
            
            populateFilters();
            applyFilters(); // This will set filteredVoters and update display
            updateCounts();
        }

        // Generate random names
        function generateRandomName() {
            const firstNames = ['John', 'Jane', 'Michael', 'Sarah', 'David', 'Emily', 'Robert', 'Lisa', 'James', 'Maria', 'William', 'Jennifer', 'Richard', 'Patricia', 'Charles', 'Linda'];
            const lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez', 'Hernandez', 'Lopez', 'Gonzalez', 'Wilson', 'Anderson', 'Thomas'];
            
            const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
            const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
            return `${firstName} ${lastName}`;
        }

        // Add markers to map (only filtered voters)
        function addMarkersToMap(voters = filteredVoters) {
            // Clear existing markers
            Object.values(markers).forEach(marker => {
                map.removeLayer(marker);
            });
            markers = {};

            voters.forEach(voter => {
                // Party-based colors
                let color;
                switch(voter.party) {
                    case 'Republican': color = '#dc3545'; break;
                    case 'Democrat': color = '#007bff'; break;
                    case 'Independent': 
                    default: color = '#6c757d'; break;
                }
                
                // Add opacity based on visited status
                const fillOpacity = voter.visited ? 0.6 : 0.9;
                const strokeColor = voter.visited ? '#28a745' : '#fff';
                const strokeWidth = voter.visited ? 3 : 2;

                const marker = L.circleMarker([voter.lat, voter.lng], {
                    radius: 8,
                    fillColor: color,
                    color: strokeColor,
                    weight: strokeWidth,
                    opacity: 1,
                    fillOpacity: fillOpacity
                }).addTo(map);

                const visitedBadge = voter.visited ? '<span class="badge bg-success">Visited</span>' : '<span class="badge bg-secondary">Pending</span>';
                
                marker.bindPopup(`
                    <div class="text-center">
                        <strong>${voter.name}</strong><br>
                        <small class="text-muted">${voter.address}</small><br>
                        <span class="badge" style="background-color: ${color}; color: white;">${voter.party}</span>
                        ${visitedBadge}<br>
                        <button class="btn btn-sm btn-primary mt-2" onclick="selectVoter(${voter.id})">
                            <i class="fas fa-crosshairs"></i> Select
                        </button>
                    </div>
                `);

                markers[voter.id] = marker;
            });

            // Fit map to show all filtered markers if there are any
            if (voters.length > 0) {
                const group = new L.featureGroup(Object.values(markers));
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Populate filter dropdowns
        function populateFilters() {
            const zips = [...new Set(votersData.map(v => v.zip))].sort();
            const streets = [...new Set(votersData.map(v => v.address.split(' ').slice(1).join(' ')))].sort();
            const precincts = [...new Set(votersData.map(v => v.precinct))].sort();

            populateSelect('zipFilter', zips);
            populateSelect('streetFilter', streets);
            populateSelect('precinctFilter', precincts);
        }

        function populateSelect(elementId, options) {
            const select = document.getElementById(elementId);
            // Keep the first option (All...)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }

        // Apply filters
        function applyFilters() {
            const zipFilter = document.getElementById('zipFilter').value;
            const partyFilter = document.getElementById('partyFilter').value;
            const streetFilter = document.getElementById('streetFilter').value;
            const precinctFilter = document.getElementById('precinctFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            filteredVoters = votersData.filter(voter => {
                if (zipFilter && voter.zip !== zipFilter) return false;
                if (partyFilter && voter.party !== partyFilter) return false;
                if (streetFilter && !voter.address.includes(streetFilter)) return false;
                if (precinctFilter && voter.precinct !== precinctFilter) return false;
                if (statusFilter === 'visited' && !voter.visited) return false;
                if (statusFilter === 'not-visited' && voter.visited) return false;
                return true;
            });

            displayVoterList(filteredVoters);
            addMarkersToMap(filteredVoters); // Update map to show only filtered voters
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('zipFilter').value = '';
            document.getElementById('partyFilter').value = '';
            document.getElementById('streetFilter').value = '';
            document.getElementById('precinctFilter').value = '';
            document.getElementById('statusFilter').value = '';
            applyFilters();
        }

        // Display voter list
        function displayVoterList(voters = filteredVoters) {
            const voterList = document.getElementById('voterList');
            const listCount = document.getElementById('listCount');
            
            listCount.textContent = voters.length;
            
            if (voters.length === 0) {
                voterList.innerHTML = '<p class="text-muted text-center">No voters match the current filters.</p>';
                return;
            }
            
            voterList.innerHTML = voters.map(voter => {
                const partyClass = `party-${voter.party.toLowerCase()}`;
                const visitedStatus = voter.visited ? 'visited' : '';
                const currentStatus = currentVoter && currentVoter.id === voter.id ? 'current' : '';
                
                return `
                    <div class="voter-card card ${partyClass} ${visitedStatus} ${currentStatus}" 
                         data-voter-id="${voter.id}" 
                         onclick="selectVoter(${voter.id})"
                         style="cursor: pointer;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <strong>${voter.name}</strong>
                                    <br><small class="text-muted">${voter.address}</small>
                                    <br><small><span class="badge" style="background-color: ${getPartyColor(voter.party)}; color: white; font-size: 0.7rem;">${voter.party}</span> | ${voter.ageClass}</small>
                                    ${voter.visited ? `<br><small class="text-success"><i class="fas fa-check"></i> Visited ${new Date(voter.visitedAt).toLocaleDateString()}</small>` : ''}
                                </div>
                                <div class="text-end">
                                    ${voter.visited ? '<span class="badge bg-success status-badge">✓</span>' : '<span class="badge bg-secondary status-badge">○</span>'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Get party color
        function getPartyColor(party) {
            switch(party) {
                case 'Republican': return '#dc3545';
                case 'Democrat': return '#007bff';
                case 'Independent': 
                default: return '#6c757d';
            }
        }

        // Select a voter
        function selectVoter(voterId) {
            currentVoter = votersData.find(v => v.id === voterId);
            if (!currentVoter) return;

            // Update map view - zoom to selected voter
            map.setView([currentVoter.lat, currentVoter.lng], 17);

            // Highlight the selected marker
            Object.values(markers).forEach(marker => {
                marker.setStyle({ weight: marker === markers[voterId] ? 4 : 2 });
            });

            // Update current voter card
            document.getElementById('currentVoterCard').style.display = 'block';
            document.getElementById('currentVoterInfo').innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <h6 class="mb-0 me-2">${currentVoter.name}</h6>
                    <span class="badge" style="background-color: ${getPartyColor(currentVoter.party)}; color: white;">${currentVoter.party}</span>
                </div>
                <p class="mb-1"><i class="fas fa-map-marker-alt"></i> <strong>Address:</strong> ${currentVoter.address}, ${currentVoter.city}, ${currentVoter.state} ${currentVoter.zip}</p>
                <p class="mb-1"><i class="fas fa-users"></i> <strong>Demographics:</strong> ${currentVoter.ageClass}, ${currentVoter.race}, ${currentVoter.gender}</p>
                <p class="mb-1"><i class="fas fa-vote-yea"></i> <strong>Precinct:</strong> ${currentVoter.precinct}</p>
                ${currentVoter.visited ? `<p class="mb-0"><small class="text-success"><i class="fas fa-check-circle"></i> Visited on ${new Date(currentVoter.visitedAt).toLocaleString()}</small></p>` : ''}
            `;

            // Load existing notes if visited
            if (currentVoter.visited) {
                document.getElementById('present').checked = currentVoter.present;
                document.getElementById('willVote').checked = currentVoter.willVote;
                document.getElementById('nextTime').checked = currentVoter.nextTime;
                document.getElementById('voterNotes').value = currentVoter.notes;
                document.getElementById('supportLevel').value = currentVoter.supportLevel;
            } else {
                document.getElementById('notesForm').reset();
            }

            // Update voter list display
            displayVoterList();
            updateCounts();

            // Scroll to notes form on mobile
            if (window.innerWidth < 768) {
                document.getElementById('currentVoterCard').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Simulate GPS tracking
        function simulateGPSTracking() {
            if (locationWatchId) {
                stopGPSTracking();
                return;
            }

            document.getElementById('locationStatus').textContent = 'Active';
            
            locationWatchId = setInterval(() => {
                // Simulate GPS movement around the map
                const centerLat = 33.1507;
                const centerLng = -96.8236;
                const randomLat = centerLat + (Math.random() - 0.5) * 0.01;
                const randomLng = centerLng + (Math.random() - 0.5) * 0.01;
                
                canvasserLocation = { lat: randomLat, lng: randomLng };
                updateProximityTracking();
            }, 2000);
        }

        function stopGPSTracking() {
            if (locationWatchId) {
                clearInterval(locationWatchId);
                locationWatchId = null;
                document.getElementById('locationStatus').textContent = 'Stopped';
            }
        }

        // Update proximity tracking
        function updateProximityTracking() {
            if (!canvasserLocation || !currentVoter) return;

            const distance = calculateDistance(
                canvasserLocation.lat, canvasserLocation.lng,
                currentVoter.lat, currentVoter.lng
            );

            const distanceInFeet = distance * 3280.84; // Convert km to feet
            
            if (distanceInFeet <= 50) {
                timeInCurrentArea++;
                document.getElementById('locationStatus').textContent = `Within 50ft (${Math.round(distanceInFeet)}ft)`;
            } else {
                timeInCurrentArea = 0;
                document.getElementById('locationStatus').textContent = `${Math.round(distanceInFeet)}ft away`;
            }
            
            document.getElementById('timeInArea').textContent = timeInCurrentArea;
        }

        // Calculate distance between two points
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Radius of the Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Auto-visit nearby voters (for demo)
        function autoVisitNearby() {
            const unvisitedVoters = votersData.filter(v => !v.visited);
            const toVisit = unvisitedVoters.slice(0, Math.min(10, unvisitedVoters.length));
            
            toVisit.forEach((voter, index) => {
                setTimeout(() => {
                    voter.visited = true;
                    voter.visitedAt = new Date().toISOString();
                    voter.present = Math.random() > 0.3;
                    voter.willVote = Math.random() > 0.4;
                    voter.nextTime = Math.random() > 0.7;
                    voter.supportLevel = ['strong-support', 'lean-support', 'undecided', 'lean-oppose'][Math.floor(Math.random() * 4)];
                    voter.notes = `Demo visit - ${voter.present ? 'Home' : 'Not home'}`;
                    
                    // Update marker style if it's currently shown
                    if (markers[voter.id]) {
                        markers[voter.id].setStyle({ 
                            fillOpacity: 0.6,
                            color: '#28a745',
                            weight: 3
                        });
                    }
                    
                    if (index === toVisit.length - 1) {
                        applyFilters(); // Refresh both list and map
                        updateCounts();
                    }
                }, index * 500);
            });
        }

        // Handle notes form submission
        document.getElementById('notesForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!currentVoter) {
                alert('Please select a voter first');
                return;
            }

            // Save notes
            currentVoter.visited = true;
            currentVoter.visitedAt = new Date().toISOString();
            currentVoter.present = document.getElementById('present').checked;
            currentVoter.willVote = document.getElementById('willVote').checked;
            currentVoter.nextTime = document.getElementById('nextTime').checked;
            currentVoter.notes = document.getElementById('voterNotes').value;
            currentVoter.supportLevel = document.getElementById('supportLevel').value;

            // Update marker style if it's currently shown
            if (markers[currentVoter.id]) {
                markers[currentVoter.id].setStyle({ 
                    fillOpacity: 0.6,
                    color: '#28a745',
                    weight: 3
                });
            }

            // Update displays
            applyFilters(); // Refresh both list and map
            updateCounts();
            
            // Show success message
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-success alert-dismissible fade show position-fixed';
            successAlert.style.cssText = 'top: 70px; right: 20px; z-index: 1050; min-width: 250px;';
            successAlert.innerHTML = `
                <i class="fas fa-check-circle"></i> Notes saved and voter marked as visited!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(successAlert);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (successAlert.parentNode) {
                    successAlert.remove();
                }
            }, 3000);
        });

        // Update counts
        function updateCounts() {
            const totalVoters = votersData.length;
            const visitedCount = votersData.filter(v => v.visited).length;
            
            document.getElementById('totalVoters').textContent = totalVoters;
            document.getElementById('visitedCount').textContent = visitedCount;
        }

        // Generate summary
        function generateSummary() {
            const visitedVoters = votersData.filter(v => v.visited);
            const totalTargeted = votersData.length;
            const totalVisited = visitedVoters.length;
            
            if (totalVisited === 0) {
                document.getElementById('summaryContent').innerHTML = '<p class="text-muted">No visits recorded yet today.</p>';
                return;
            }
            
            // Demographics breakdown
            const partyBreakdown = {};
            const ageBreakdown = {};
            const raceBreakdown = {};
            const responseBreakdown = {
                present: 0,
                willVote: 0,
                nextTime: 0
            };
            const supportBreakdown = {};

            visitedVoters.forEach(voter => {
                // Party
                partyBreakdown[voter.party] = (partyBreakdown[voter.party] || 0) + 1;
                
                // Age
                ageBreakdown[voter.ageClass] = (ageBreakdown[voter.ageClass] || 0) + 1;
                
                // Race
                raceBreakdown[voter.race] = (raceBreakdown[voter.race] || 0) + 1;
                
                // Responses
                if (voter.present) responseBreakdown.present++;
                if (voter.willVote) responseBreakdown.willVote++;
                if (voter.nextTime) responseBreakdown.nextTime++;
                
                // Support
                if (voter.supportLevel) {
                    supportBreakdown[voter.supportLevel] = (supportBreakdown[voter.supportLevel] || 0) + 1;
                }
            });

            const summaryHTML = `
                <div class="summary-card mb-3">
                    <h6><i class="fas fa-chart-line"></i> Overall Progress</h6>
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="h4">${totalTargeted}</div>
                            <small>Targeted</small>
                        </div>
                        <div class="col-4">
                            <div class="h4">${totalVisited}</div>
                            <small>Visited</small>
                        </div>
                        <div class="col-4">
                            <div class="h4">${Math.round((totalVisited/totalTargeted)*100)}%</div>
                            <small>Complete</small>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12 mb-3">
                        <h6><i class="fas fa-users"></i> Party Breakdown</h6>
                        ${Object.entries(partyBreakdown).map(([party, count]) => `
                            <div class="d-flex justify-content-between">
                                <span><span class="badge me-1" style="background-color: ${getPartyColor(party)}; width: 12px; height: 12px; border-radius: 50%;"></span>${party}:</span> 
                                <span><strong>${count}</strong></span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="col-12 mb-3">
                        <h6><i class="fas fa-clipboard-check"></i> Response Summary</h6>
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-home text-primary"></i> Present:</span> <span><strong>${responseBreakdown.present}</strong> (${Math.round((responseBreakdown.present/totalVisited)*100)}%)</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-vote-yea text-success"></i> Will Vote:</span> <span><strong>${responseBreakdown.willVote}</strong> (${Math.round((responseBreakdown.willVote/totalVisited)*100)}%)</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-clock text-warning"></i> Next Time:</span> <span><strong>${responseBreakdown.nextTime}</strong> (${Math.round((responseBreakdown.nextTime/totalVisited)*100)}%)</span>
                        </div>
                    </div>
                    
                    ${Object.keys(supportBreakdown).length > 0 ? `
                    <div class="col-12">
                        <h6><i class="fas fa-thumbs-up"></i> Support Levels</h6>
                        ${Object.entries(supportBreakdown).map(([level, count]) => `
                            <div class="d-flex justify-content-between">
                                <span>${level.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}:</span> 
                                <span><strong>${count}</strong> (${Math.round((count/totalVisited)*100)}%)</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('summaryContent').innerHTML = summaryHTML;
        }
    </script>
</body>
</html>